#! /bin/bash

usage(){
        echo "Usage: /usr/local/bin/foreachwikiindblist /srv/mediawiki/cache/<dblist>.json or <dblist>.php /srv/mediawiki/<version>/<maintenance script> <any other options if needed> <start> <end>"
        exit 1
}

[[ $# -lt 2 ]] && usage

dblist=$1
shift
script=$1
shift

start_string=${1:-}
end_string=${2:-}

if [ ! -f "$dblist" ]; then
        echo "dblist does not exist!"
        usage
        exit 1
fi

if [[ "$dblist" == *.json ]]; then
        wikis=$(/usr/bin/jq ".combi | keys | .[]" "$dblist" | sed 's/.//;s/.$//')
elif [[ "$dblist" == *.php ]]; then
        # Load the PHP array and output the keys (wiki database names)
        wikis=$(/usr/bin/php -r "
            \$list = include '$dblist';
            if ( is_array( \$list['databases'] ?? false ) ) {
                echo implode( PHP_EOL, array_keys( \$list['databases'] ) );
            }
        ")
else
        echo "Unsupported file format. Please provide a .json or .php file."
        usage
        exit 1
fi

# Filter wikis based on start and end strings if provided
filtered_wikis=$(echo "$wikis" | awk -v start="$start_string" -v end="$end_string" '
    (start == "" || index($0, start) == 1) && (end == "" || index($0, end) > 0)
')

for wiki in $filtered_wikis
do
        echo "Running ${script} $* for $wiki"
        /usr/bin/php "$script" "$@" --wiki "$wiki"
done
